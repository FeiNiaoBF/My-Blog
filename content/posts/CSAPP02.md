---
title: "二.程序的机器级表示(CSAPP)"
date: 2023-04-09T20:13:06+08:00
draft: true
tags: [CSAPP]
categories: ["CSAPP"]
author: ["Yeelight"]
showtoc: true
---

# 历史发展和基本概念

## 微处理器历史

### Intel的x86

在这里我想来简单的说道说道微处理器的历史发展，特此说明一下我不是专业的🙄，因此我没有详细的`深入研究`，如果有任何的错误请告诉我，谢谢。

自从1971年的Intel4004既第一款微处理器，也是全球第一款微处理器开始，我们人类社会标志着进入微芯片时代，在这个时代有三个主要的趋势：
- 处理器的位长的倍增
- 指令集的快速发展
- 时钟频率的快速增加

Intel也逐步发布了`Intel 8008`一个8位的，`Intel 8086` 一个16位的，至此，Intel的x86`帝国`开始了。在1985年，Intel的32位处理器`IA32`问世，而随着摩尔定律等的种种限制，单核的处理器已经遇到瓶颈了，各大公司继而转向了高频率、低功耗的多核处理器，处理器进入多核/多线程时代（2005）。

在一些无论是竞争关系，还是研究关系，导致目前的市场上出现了两种**指令集计算机**
- CISC(*Complex instruction set computer*)
- RISC(*Reduced instruction set computer*)

在后面我会再提到的。

我不知道未来的处理器向哪个方向发展，也不知道Intel是否一直在前沿（AMD：呵呵），但我相信，人类的智慧使得世界自第二次工业革命以来史无前例的大发展，在未来一定有着不一样的发展。

## 基本概念

>嗯嗯，回来回来，不去想未来，做好当下。

在了解具体的体系系统前，我们来了解基本的一些东西：

![CS61cCS](/img/CS61cCS.png)

上面是来自CS61c的图片，我们现在要了解就是整个软件到硬件的过程，也可以说是抽象到具体的过程。

**Instructure Set Architecture**：指令集架构 (包括指令规格，不同规则寄存器等)，简称ISA，它是软硬件之间的`桥梁`。

**Processor**、**Memory**、**I/Osystem**：这是由OS进行控制的。

我们这章主要的是学习ISA，CSAPP主要是x86-64的CISC指令集，CS61c主要是RISC-V的RISC指令集，没错，它们是不同的指令集，在我的笔记里面我也会不时的写上RISC-V的一些表示来证明我学习过了（笑）。

### 什么是编译

```txt
高级语言 --> 汇编语言 --> 机器语言
```

在我们的零章的时候我说过一个*.c文件如何变成的一个可执行的程序的一个主要过程，它有一个步骤是**编译**，这是一个我们需要细细品味的步骤。

编译过程是一个由某个高级语言（比如c文件）经过编译器的一系列的处理成为可读性低的汇编语言。换而言之，就是把我们十分清楚明白的抽象语言转换成机器语言（值得注意的是，此时机器也不知道汇编语言），在经历汇编译器**翻译**成二进制代码，真正的机器语言，机器可以读懂了，但我们看不懂（除了某些黑客）。

![CALL](/img/CALL-CS61c.png)

上面是cs61c中的*从C到机器语言*的完整过程，十分的详细了。程序的运行就是想像是一个**翻译**过程，用上一些我们明文规定的语法规则，使用编译器（GCC等）来当我们程序员和机器的**翻译官**。

现在来看一看从 `C语言` 到`机器代码`(一个整型加法计算的汇编代码)

```c
  // filename: clcyle_one
#include <stdio.h>
int main(int argc, char const *argv[])
{
    int sum = 0;
    for (int i = 0; i < 10; ++i)
    {
        sum += i;
    }
    return 0;
}
```

经过gcc的编译（对于指令不熟的同学只要记住一些常用的就好了）

我在我的Linux机器上使用以下的代码

```shell
$ gcc -Og -S clcyle_one.c
```

```asm

    .file   "clcyle_one.c"
    .text
    .globl  main
    .type   main, @function
main:
.LFB7:
    .cfi_startproc
    movl    $0, %eax
    jmp .L2
.L3:
    addl    $1, %eax
.L2:
    cmpl    $9, %eax
    jle .L3
    movl    $0, %eax
    ret
    #（不用在意类似 .file 的指令，它们是伪指令， 要从main看起）
```

两者相互比较一下我们可以发现，C 语言代码被处理成统一格式的汇编代码，在汇编代码中，第一个字符串叫做操作符，后面的是源和目的`寄存器`（这是一个大玩意😣）。操作和操作数明确，在下面我们会到不同的操作符分类分析（我想把RISC-V的加入作比较），记住一个条件，`读取`/`运算操作`是一个**线性逐句逐次**的操作，PC指令是有现态和次态的。

## 处理器的工作

在我们对操作指令分类讨论之前我们来认识处理器是怎么工作的，

![x86-64](/img/x86-64cpu.jpg)

![cs61c cpu](/img/Components%20of%20a%20Computer.png)

上面的图片(分别来自CS61c和CSapp)十分清楚的展示了处理器对于存放在主存里面的指令有着什么样的操作，主要的就两点**存、读取值**和**计算**。在x86-64里面还有一个叫作**条件码**的flag，我会在下面说到因为我也第一次看见这个。

这是一个**CPU到Memory**的一个过程，具体的是一个处理器从内存某个地址取值（有数据和指令）拿到**CPU**里的**寄存器**通过**ALU**计算，再根据**PC**选择下一步。

- **程序计数器**(PC, Program counter) - 存着下一条指令的地址，在 x86-64 中称为 RIP。
- **寄存器**(Register) - 用来存储数据以便操作。
- **条件代码**(Codition codes) - 通常保存最近的算术或逻辑操作后的信息，用来做条件跳转的条件。

## 什么是ISA

Instruction Set Architecture 指令集是包含了针对某个特定处理器执行的基本操作码（opcode），里面是基本命令，在我们学习的x86-64、RISC-V都有不同的ISA。

为了学习方便，我们要把ISA根据使用的方法不同进行不同的分类。
- 资料处理与访问操作
- 算术逻辑操作
- 控制过程操作

在下面我会一一分析。

## CISC&RISC区别

CISC(*Complex instruction set computer*)
> 兼容性性强，指令繁多，长度可变，由微程序实现。
> 代表：x86-64

RISC(*Reduced instruction set computer*)
> 指令少，使用频率接近，主要是依靠硬件实现（通用寄存器、硬布线逻辑控制）。
> 代表：RISC-V


# 开始快乐的汇编

## 整型寄存器

![Reg](/img/x86-64reg.png)

在x86-64上有16个64位的**通用寄存器**；对于每个寄存器的低32、16和8位可以独立地通过其他不同指令名称访问，原则上，几乎任何寄存器都可以用于保存几乎任何逻辑和算术操作的操作数，但有些具有特殊或受限制的用途。

一个寄存器有着64位、32位、16位、8位这可以对以前的低位程序向下兼容。

按照惯例，%rsp被保留作为堆栈指针，并且因为一些指令（例如push、pop、call）隐含使用它。%rsp指向最低占用的堆栈位置（而不是下一个要使用的位置）。

寄存器%rbp有时被用作帧指针，即当前堆栈帧的基址。指令计数器寄存器（％rip） 指向要执行的下一条命令; 程序员无法直接访问它, 但是大量地被用作基于位置无关代码寻址的基础。还有一些其他指令隐含地使用某些寄存器；例如，整数乘法和除法指令需要%rax和%rdx。

## 数据类型

既然我们的寄存器有着不同位的表示，那就是说处理器在操作不同的数据时使用着不同位数的寄存器来提高速率。

我们针对不同的数据类型使用不同的**suffix**和**size**：

| Data type | suffix | size | word|
| :---: | :---: | :---: | :---: |
| char | b | 1B | Byet |
| short | w | 2B | 1word |
| int | l | 4B | 2word |
| long | q | 8B | 4word |
| char* | q | 8B | 4word |
| float | s | 4B | 2word |
| double | l | 8B | 4word |

上面的**suffix**列显示了在 GNU 汇编程序用来指定适当大小的变体的字母指示。

而一个新单位**word**是相等于2个字节的大小。




## 外部链接

[摩尔定律---Wiki](https://zh.wikipedia.org/wiki/%E6%91%A9%E5%B0%94%E5%AE%9A%E5%BE%8B)
[微处理器---Wiki](https://zh.wikipedia.org/wiki/%E5%BE%AE%E5%A4%84%E7%90%86%E5%99%A8)
[*The 50 Year History of the Microprocessor*](https://zhuanlan.zhihu.com/p/511271401)
[芯片相关-- Cpu历史--AMD系列](https://zhuanlan.zhihu.com/p/464721330)
[芯片相关-- Cpu历史--intel系列](https://zhuanlan.zhihu.com/p/464413953)
